<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a2a6c">
    <title>Sync Player Pro</title>
    <link rel="icon" href="https://www.pngmart.com/files/3/Play-Button-PNG-Free-Download.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(45deg, #ff8a00, #e52e71);
            --bg-gradient: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            --control-bg: rgba(0, 0, 0, 0.7);
            --text-color: #ffffff;
            --input-bg: rgba(255, 255, 255, 0.15);
            --input-focus: rgba(255, 255, 255, 0.25);
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            --transition: all 0.3s ease;
            --modal-bg: rgba(0, 0, 0, 0.85);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: var(--bg-gradient);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 16px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 960px;
            padding: 24px;
            color: var(--text-color);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        /* Notification styles */
        .notification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 12px 20px;
            background: var(--control-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 8px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 2147483647;
            display: none;
            max-width: 90%;
            text-align: center;
            pointer-events: none;
        }

        .notification.show {
            display: flex;
            opacity: 1;
            animation: fadeInOut 3s ease;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) translateY(20px);
            }
            10% {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
            90% {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) translateY(-20px);
            }
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-color);
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
        }

        .notification i {
            color: #4ade80;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--modal-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: rgba(30, 30, 40, 0.95);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transform: translateY(20px);
            transition: transform 0.3s ease;
            position: relative;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-close:hover {
            color: #e52e71;
            transform: rotate(90deg);
        }

        .queue-list {
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .queue-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
            transition: var(--transition);
        }

        .queue-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .queue-item-info {
            flex: 1;
            text-align: left;
            margin-right: 10px;
            overflow: hidden;
        }

        .queue-item-title {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .queue-item-url {
            font-size: 0.8rem;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .queue-item-remove {
            background: rgba(255, 0, 0, 0.3);
            border: none;
            color: var(--text-color);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .queue-item-remove:hover {
            background: rgba(255, 0, 0, 0.5);
            transform: scale(1.1);
        }

        .queue-empty {
            padding: 20px;
            opacity: 0.7;
            font-style: italic;
        }

        .queue-form {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .queue-input {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-color);
            outline: none;
            transition: var(--transition);
        }

        .queue-input:focus {
            background: var(--input-focus);
            box-shadow: 0 0 0 2px rgba(255, 138, 0, 0.3);
        }

        .queue-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .queue-submit {
            padding: 0 20px;
            background: var(--primary-gradient);
            border: none;
            border-radius: 8px;
            color: var(--text-color);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .queue-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(229, 46, 113, 0.4);
        }

        .queue-submit:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .queue-limit {
            font-size: 0.9rem;
            margin-top: 10px;
            opacity: 0.7;
        }

        header {
            margin-bottom: 24px;
        }

        h1 {
            font-size: clamp(1.8rem, 5vw, 2.4rem);
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            font-size: clamp(0.9rem, 3vw, 1rem);
            opacity: 0.8;
            margin-top: 8px;
        }

        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 24px;
            justify-content: center;
            align-items: center;
        }

        .input-container {
            position: relative;
            display: flex;
            align-items: center;
            width: 100%;
            max-width: 500px;
            gap: 8px;
            min-width: 0;
        }

        #videoUrl {
            flex: 1;
            min-width: 0;
            padding: 12px 16px;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            background: var(--input-bg);
            color: var(--text-color);
            outline: none;
            transition: var(--transition);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #videoUrl:focus {
            background: var(--input-focus);
            box-shadow: 0 0 0 3px rgba(255, 138, 0, 0.2);
        }

        #videoUrl::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        #loadVideo, .action-btn, .destroy-room-btn, .next-video-btn, .copy-icon {
            min-width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            cursor: pointer;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        #loadVideo {
            padding: 0 16px;
            background: var(--primary-gradient);
            border: none;
            color: var(--text-color);
            font-size: 0.95rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(229, 46, 113, 0.3);
        }

        #loadVideo:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(229, 46, 113, 0.4);
        }

        .copy-icon, .destroy-room-btn, .next-video-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: var(--text-color);
            font-size: 1rem;
            border-radius: 8px;
            padding: 0 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .copy-success {
            font-size: 0.85rem;
            color: #4ade80;
            opacity: 0;
            transition: opacity 0.3s ease;
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
        }

        .copy-success.show {
            opacity: 1;
        }

        .copy-icon:hover, .destroy-room-btn:hover, .next-video-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.05);
        }

        .destroy-room-btn {
            background: rgba(255, 0, 0, 0.7);
        }

        .destroy-room-btn:hover {
            background: rgba(255, 0, 0, 0.9);
        }

        .next-video-btn {
            background: rgba(0, 128, 0, 0.7);
            position: relative;
        }

        .next-video-btn:hover {
            background: rgba(0, 128, 0, 0.9);
        }

        .next-video-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #e52e71;
            color: var(--text-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .video-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16 / 9;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin: 0 auto 24px;
            box-shadow: var(--shadow);
            max-width: 720px;
        }

        #player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .controls-container {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            padding: 12px;
            display: flex;
            justify-content: center;
            z-index: 10;
            opacity: 1;
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: auto;
        }

        .controls-container.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .controls {
            background: var(--control-bg);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            gap: 12px;
            box-shadow: var(--shadow);
            align-items: center;
        }

        .control-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: var(--text-color);
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: var(--transition);
            flex-shrink: 0;
            position: relative;
        }

        .control-btn.subtitle {
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 0;
            padding-bottom: 0;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.05);
        }

        .control-btn.play-pause {
            background: var(--primary-gradient);
            width: 44px;
            height: 44px;
            font-size: 1.3rem;
        }

        /* Mode indicator styles */
        .mode-indicator {
            position: absolute;
            top: 16px;
            left: 16px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            background: var(--control-bg);
            display: none;
            z-index: 10;
        }

        .host-indicator {
            background: var(--primary-gradient);
        }

        .joiner-indicator {
            background: linear-gradient(45deg, #00c6ff, #0072ff);
        }

        .feedback-container {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .feedback-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            border: none;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .feedback-btn:hover {
            transform: scale(1.1);
        }

        .feedback-btn.raise-hand {
            color: #4ade80;
        }

        /* Footer with platform icons */
        .footer-icons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .footer-icon {
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
            animation: float 3s ease-in-out infinite;
        }

        .footer-icon:hover {
            color: white;
            transform: scale(1.2);
        }

        /* Different animation delays for each icon */
        .footer-icon:nth-child(1) { animation-delay: 0s; }
        .footer-icon:nth-child(2) { animation-delay: 0.5s; }
        .footer-icon:nth-child(3) { animation-delay: 1s; }
        .footer-icon:nth-child(4) { animation-delay: 1.5s; }
        .footer-icon:nth-child(5) { animation-delay: 2s; }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @media (max-width: 768px) {
            .input-group {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .input-container {
                flex-direction: row;
                max-width: 100%;
            }

            #videoUrl {
                width: 100%;
                max-width: none;
            }

            .controls {
                gap: 6px;
                padding: 8px;
            }

            .control-btn {
                width: 36px;
                height: 36px;
                font-size: 0.9rem;
            }

            .control-btn.play-pause {
                width: 36px;
                height: 36px;
                font-size: 1.1rem;
            }

            .copy-icon, .destroy-room-btn, .next-video-btn {
                width: auto;
                padding: 0 10px;
                height: 36px;
            }

            .feedback-btn {
                width: 32px;
                height: 32px;
                font-size: 0.9rem;
            }
            
            .modal {
                width: 95%;
                padding: 16px;
            }
            
            .queue-item {
                padding: 10px 12px;
            }
            
            .queue-form {
                flex-direction: column;
            }
            
            .queue-submit {
                padding: 12px;
            }
            
            .footer-icon {
                font-size: 1.2rem;
            }
        }

        .click-blocker {
            position: absolute;
            left: 0;
            width: 100%;
            background: transparent;
            z-index: 5;
            pointer-events: auto;
        }

        .click-blocker.top {
            top: 0;
            height: 37%;
        }

        .click-blocker.middle {
            top: 37%;
            height: 30%;
        }

        .click-blocker.bottom {
            bottom: 0;
            height: 50%;
        }

        .full-button::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Queue Management Modal -->
        <div class="modal-overlay" id="queueModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">Video Queue</h3>
                    <button class="modal-close" id="closeQueueModal">&times;</button>
                </div>
                <div class="queue-list" id="queueList">
                    <div class="queue-empty">Queue is empty</div>
                </div>
                <div class="queue-form">
                    <input type="text" class="queue-input" id="queueInput" placeholder="Enter video URL">
                    <button class="queue-submit" id="queueSubmit">Add</button>
                </div>
                <div class="queue-limit">Max 3 videos in queue</div>
            </div>
        </div>
        
        <header>
            <h1>Sync Player Pro</h1>
            <div class="subtitle">Watch videos together in real-time with support for multiple platforms</div>
        </header>
        
        <div class="video-container" id="videoContainer">
            <!-- Notification -->
            <div class="notification" id="notification">
                <div class="notification-content">
                    <i class="fas fa-check-circle"></i>
                    <span id="notificationText"></span>
                </div>
            </div>
            <div class="mode-indicator" id="modeIndicator"></div>
            
            <div class="click-blocker top"></div>
            <div class="click-blocker middle"></div>
            <div class="click-blocker bottom"></div>
            <div class="feedback-container" id="feedbackContainer">
                <button class="feedback-btn raise-hand full-button" id="raiseHandBtn" title="Raise Hand">
                    <i class="fas fa-hand-paper"></i>
                </button>
            </div>
            <div class="controls-container" id="controlsContainer">
                <div class="controls" id="hostControls">
                    <button class="control-btn backward full-button" title="Backward 10s" id="backwardBtn">
                        <i class="fas fa-backward"></i>
                    </button>
                    <button class="control-btn play-pause full-button" title="Play/Pause" id="playPauseBtn">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="control-btn forward full-button" title="Forward 10s" id="forwardBtn">
                        <i class="fas fa-forward"></i>
                    </button>
                    <button class="control-btn quality full-button" title="Quality" id="qualityBtn">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="control-btn subtitle full-button" title="Toggle Subtitle" id="subtitleBtn">
                        <i class="fas fa-closed-captioning"></i>
                    </button>
                    <button class="control-btn fullscreen full-button" title="Fullscreen" id="fullscreenBtn">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
                <div class="controls" id="joinerControls" style="display: none;">
                    <button class="control-btn next-video full-button" title="Manage Queue" id="joinerNextVideoBtn">
                        <i class="fas fa-list-ul"></i>
                    </button>
                    <button class="control-btn quality full-button" title="Quality" id="joinerQualityBtn">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="control-btn subtitle full-button" title="Toggle Subtitle" id="joinerSubtitleBtn">
                        <i class="fas fa-closed-captioning"></i>
                    </button>
                    <button class="control-btn leave-room full-button" title="Leave Room" id="leaveRoomBtn">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                    <button class="control-btn fullscreen full-button" title="Fullscreen" id="joinerFullscreenBtn">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            <div id="player"></div>
        </div>
        <div class="input-group" id="inputGroup">
            <div class="input-container">
                <input type="url" id="videoUrl" placeholder="Enter video URL" aria-label="Video URL">
                <button id="loadVideo" class="full-button">Load</button>
                <button class="destroy-room-btn full-button" id="destroyRoomBtn" title="Destroy Room" style="display: none;">
                    <i class="fas fa-times"></i>
                </button>
                <button class="next-video-btn full-button" id="nextVideoBtn" title="Manage Queue">
                    <i class="fas fa-list-ul"></i>
                    <span class="next-video-badge" id="nextVideoBadge">0</span>
                </button>
                <button class="copy-icon full-button" id="copyRoomLink" title="Copy Room Link" style="display: none;">
                    <i class="fas fa-copy"></i>
                </button>
                <span class="copy-success" id="copySuccess">Room link copied to clipboard</span>
            </div>
        </div>
        
        <!-- Footer with platform icons -->
        <div class="footer-icons">
            <i class="fab fa-youtube footer-icon" title="YouTube"></i>
            <i class="fab fa-vimeo-v footer-icon" title="Vimeo"></i>
            <i class="fas fa-music footer-icon" title="Direct Media"></i>
            <i class="fab fa-soundcloud footer-icon" title="SoundCloud"></i>
        </div>
    </div>

    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <!-- Vimeo Player API -->
    <script src="https://player.vimeo.com/api/player.js"></script>

    <!-- Sound Player API -->
    <script src="https://w.soundcloud.com/player/api.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <script>
       // Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyDsPjwl2fsQwua_HZTPJSDmtlgzRkgVXQ4",
    authDomain: "sync-f5dd9.firebaseapp.com",
    databaseURL: "https://sync-f5dd9-default-rtdb.firebaseio.com",
    projectId: "sync-f5dd9",
    storageBucket: "sync-f5dd9.appspot.com",
    messagingSenderId: "891545015962",
    appId: "1:891545015962:web:e68867deec0117fe85f123"
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Global variables
let player;
let isPlaying = false;
let roomId = null;
let roomRef = null;
let isHost = false;
let isJoiner = false;
let hostControls = true;
let joinerCount = 0;
let pendingVideoId = null;
let apiReady = false;
let syncInterval = null;
let previousJoinerCount = 0;
let controlsTimeout = null;
let nextVideos = [];
let currentQuality = 'auto';
let raiseHandCount = 0;
let currentVideoIndex = 0;
let playerReady = false;
let lastRoomState = null;
let playerLoadAttempts = 0;
let audioContext;
let beepBuffer;
let currentPlatform = 'youtube';
let vimeoPlayer = null;

// DOM elements
const elements = {
    videoUrl: document.getElementById('videoUrl'),
    loadVideo: document.getElementById('loadVideo'),
    playPauseBtn: document.getElementById('playPauseBtn'),
    backwardBtn: document.getElementById('backwardBtn'),
    forwardBtn: document.getElementById('forwardBtn'),
    qualityBtn: document.getElementById('qualityBtn'),
    subtitleBtn: document.getElementById('subtitleBtn'),
    nextVideoBtn: document.getElementById('nextVideoBtn'),
    nextVideoBadge: document.getElementById('nextVideoBadge'),
    fullscreenBtn: document.getElementById('fullscreenBtn'),
    notification: document.getElementById('notification'),
    notificationText: document.getElementById('notificationText'),
    modeIndicator: document.getElementById('modeIndicator'),
    inputGroup: document.getElementById('inputGroup'),
    copyRoomLink: document.getElementById('copyRoomLink'),
    copySuccess: document.getElementById('copySuccess'),
    controlsContainer: document.getElementById('controlsContainer'),
    videoContainer: document.getElementById('videoContainer'),
    destroyRoomBtn: document.getElementById('destroyRoomBtn'),
    hostControls: document.getElementById('hostControls'),
    joinerControls: document.getElementById('joinerControls'),
    joinerNextVideoBtn: document.getElementById('joinerNextVideoBtn'),
    joinerQualityBtn: document.getElementById('joinerQualityBtn'),
    joinerSubtitleBtn: document.getElementById('joinerSubtitleBtn'),
    leaveRoomBtn: document.getElementById('leaveRoomBtn'),
    joinerFullscreenBtn: document.getElementById('joinerFullscreenBtn'),
    raiseHandBtn: document.getElementById('raiseHandBtn'),
    feedbackContainer: document.getElementById('feedbackContainer'),
    queueModal: document.getElementById('queueModal'),
    closeQueueModal: document.getElementById('closeQueueModal'),
    queueList: document.getElementById('queueList'),
    queueInput: document.getElementById('queueInput'),
    queueSubmit: document.getElementById('queueSubmit')
};

// Supported platforms with detection regex and API integration
const supportedPlatforms = {
    youtube: {
        id: 'youtube',
        regex: /(youtube\.com|youtu\.be)/,
        name: 'YouTube',
        extractId: (url) => {
            const regExp = /^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }
    },
    vimeo: {
        id: 'vimeo',
        regex: /vimeo\.com/,
        name: 'Vimeo',
        extractId: (url) => {
            const regExp = /(?:vimeo\.com\/|video\/)(\d+)/;
            const match = url.match(regExp);
            return match ? match[1] : null;
        }
    },
    direct: {
        id: 'direct',
        regex: /\.(mp4|webm|ogg|mov|avi|mkv|mp3|wav|m3u8)$/i,
        name: 'Direct Media',
        extractId: (url) => url
    },
    soundcloud: {
        id: 'soundcloud',
        regex: /soundcloud\.com/,
        name: 'SoundCloud',
        extractId: (url) => url
    }
};

// Debounce utility
const debounce = (func, wait) => {
    let timeout;
    return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
};

// Play beep sound using Web Audio API
function playBeep() {
    if (!audioContext) initAudio();
    if (!beepBuffer) return;
    
    try {
        const source = audioContext.createBufferSource();
        source.buffer = beepBuffer;
        source.connect(audioContext.destination);
        source.start();
    } catch (e) {
        console.error('Error playing beep:', e);
    }
}

// Initialize audio context for notification sounds
function initAudio() {
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const duration = 0.1;
        const sampleRate = audioContext.sampleRate;
        const numFrames = duration * sampleRate;
        const buffer = audioContext.createBuffer(1, numFrames, sampleRate);
        const data = buffer.getChannelData(0);
        
        for (let i = 0; i < numFrames; i++) {
            const t = i / sampleRate;
            data[i] = Math.sin(t * 440 * 2 * Math.PI) * Math.exp(-t * 5);
        }
        
        beepBuffer = buffer;
    } catch (e) {
        console.error('Audio initialization failed:', e);
    }
}

// Detect platform from URL
function detectPlatform(url) {
    if (!url) return null;
    
    // Check for direct media first
    if (url.match(supportedPlatforms.direct.regex)) {
        return supportedPlatforms.direct;
    }
    
    // Check for YouTube
    if (url.match(supportedPlatforms.youtube.regex)) {
        return supportedPlatforms.youtube;
    }
    
    // Check for Vimeo
    if (url.match(supportedPlatforms.vimeo.regex)) {
        return supportedPlatforms.vimeo;
    }
    
    // Check for SoundCloud
    if (url.match(supportedPlatforms.soundcloud.regex)) {
        return supportedPlatforms.soundcloud;
    }
    
    return null;
}

// Extract video ID from URL based on platform
function extractVideoId(url) {
    const platform = detectPlatform(url);
    if (!platform) return null;
    
    return platform.extractId(url);
}

// Initialize YouTube player
function createYouTubePlayer(videoId) {
    if (!apiReady) {
        pendingVideoId = videoId;
        return;
    }
    
    try {
        // Clear previous player if exists
        if (player) {
            player.destroy();
        }
        
        player = new YT.Player('player', {
            height: '100%',
            width: '100%',
            videoId,
            playerVars: {
                rel: 0,
                modestbranding: 1,
                playsinline: 1,
                enablejsapi: 1,
                controls: 0,
                cc_load_policy: 0,
                suggestedQuality: currentQuality
            },
            events: {
                onReady: onPlayerReady,
                onStateChange: onPlayerStateChange,
                onError: onPlayerError
            }
        });
        
        // Set a timeout to check if player loaded
        setTimeout(() => {
            if (!playerReady) {
                retryPlayerCreation(videoId);
            }
        }, 5000);
    } catch (error) {
        console.error('Error creating YouTube player:', error);
        showNotification('Failed to initialize YouTube player');
        retryPlayerCreation(videoId);
    }
}

// Create Vimeo player
function createVimeoPlayer(videoId) {
    try {
        const iframe = document.createElement('iframe');
        iframe.src = `https://player.vimeo.com/video/${videoId}?autoplay=0&loop=0&byline=0&portrait=0&title=0&api=1&muted=0`;
        iframe.width = '100%';
        iframe.height = '100%';
        iframe.frameBorder = '0';
        iframe.allow = 'autoplay; fullscreen';
        iframe.allowFullscreen = true;
        
        document.getElementById('player').innerHTML = '';
        document.getElementById('player').appendChild(iframe);
        
        // Initialize Vimeo Player API
        vimeoPlayer = new Vimeo.Player(iframe);
        
        // Set volume when player is ready
        vimeoPlayer.on('loaded', () => {
            vimeoPlayer.setVolume(1).catch(e => console.log('Volume set error:', e));
        });
        
        vimeoPlayer.on('play', function() {
            isPlaying = true;
            elements.playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            if (isHost && roomRef) {
                vimeoPlayer.getCurrentTime().then(function(currentTime) {
                    roomRef.update({
                        state: 'playing',
                        currentTime: currentTime,
                        lastUpdated: firebase.database.ServerValue.TIMESTAMP
                    });
                });
            }
        });
        
        vimeoPlayer.on('pause', function() {
            isPlaying = false;
            elements.playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            if (isHost && roomRef) {
                vimeoPlayer.getCurrentTime().then(function(currentTime) {
                    roomRef.update({
                        state: 'paused',
                        currentTime: currentTime,
                        lastUpdated: firebase.database.ServerValue.TIMESTAMP
                    });
                });
            }
        });
        
        vimeoPlayer.on('ended', function() {
            if (nextVideos.length > 0) {
                const nextVideo = nextVideos.shift();
                loadVideoByUrl(nextVideo);
                if (isHost && roomRef) {
                    roomRef.update({
                        videoUrl: nextVideo,
                        nextVideos,
                        lastUpdated: firebase.database.ServerValue.TIMESTAMP
                    });
                }
                currentVideoIndex++;
                updateBadge();
                updateQueueList();
            }
        });
        
        vimeoPlayer.on('error', function(error) {
            console.error('Vimeo player error:', error);
            showNotification('Error playing Vimeo video');
        });
        
        // Add fullscreen change handler
        vimeoPlayer.on('fullscreenchange', (data) => {
            if (data.fullscreen) {
                elements.fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                elements.joinerFullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
            } else {
                elements.fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                elements.joinerFullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            }
        });
        
        playerReady = true;
        isPlaying = false;
        elements.playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        player = iframe;
        
        resetControlsTimeout();
    } catch (error) {
        console.error('Error creating Vimeo player:', error);
        showNotification('Failed to initialize Vimeo player');
    }
}

// Create SoundCloud player
function createSoundCloudPlayer(url) {
    try {
        const iframe = document.createElement('iframe');
        iframe.src = `https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&auto_play=false&hide_related=true&show_comments=false&show_user=false&show_reposts=false&visual=false`;
        iframe.width = '100%';
        iframe.height = '100%';
        iframe.frameBorder = '0';
        iframe.allow = 'autoplay';
        
        document.getElementById('player').innerHTML = '';
        document.getElementById('player').appendChild(iframe);
        
        // Initialize SoundCloud Widget API
        const widget = SC.Widget(iframe);
        window.soundcloudWidget = widget; // Store globally
        
        widget.bind(SC.Widget.Events.READY, () => {
            playerReady = true;
            elements.playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            
            if (lastRoomState) {
                widget.seekTo(lastRoomState.currentTime * 1000);
                if (lastRoomState.state === 'playing') {
                    widget.play();
                }
            }
        });
        
        widget.bind(SC.Widget.Events.PLAY, () => {
            isPlaying = true;
            elements.playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
        });
        
        widget.bind(SC.Widget.Events.PAUSE, () => {
            isPlaying = false;
            elements.playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        });
        
        // Hide unsupported controls
        elements.backwardBtn.style.display = 'none';
        elements.forwardBtn.style.display = 'none';
        elements.subtitleBtn.style.display = 'none';
        
        resetControlsTimeout();
    } catch (error) {
        console.error('Error creating SoundCloud player:', error);
        showNotification('Failed to initialize SoundCloud player');
    }
}

// Create direct media player
function createDirectMediaPlayer(url) {
    try {
        const videoElement = document.createElement('video');
        videoElement.src = url;
        videoElement.controls = false;
        videoElement.style.width = '100%';
        videoElement.style.height = '100%';
        
        document.getElementById('player').innerHTML = '';
        document.getElementById('player').appendChild(videoElement);
        
        playerReady = true;
        isPlaying = false;
        elements.playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        player = videoElement;
        
        // Set up event listeners
        videoElement.addEventListener('play', () => {
            isPlaying = true;
            elements.playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            if (isHost && roomRef) {
                roomRef.update({
                    state: 'playing',
                    currentTime: videoElement.currentTime,
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP
                });
            }
        });
        
        videoElement.addEventListener('pause', () => {
            isPlaying = false;
            elements.playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            if (isHost && roomRef) {
                roomRef.update({
                    state: 'paused',
                    currentTime: videoElement.currentTime,
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP
                });
            }
        });
        
        videoElement.addEventListener('ended', () => {
            if (nextVideos.length > 0) {
                const nextVideo = nextVideos.shift();
                loadVideoByUrl(nextVideo);
                if (isHost && roomRef) {
                    roomRef.update({
                        videoUrl: nextVideo,
                        nextVideos,
                        lastUpdated: firebase.database.ServerValue.TIMESTAMP
                    });
                }
                currentVideoIndex++;
                updateBadge();
                updateQueueList();
            }
        });
        
        videoElement.addEventListener('error', () => {
            showNotification('Error playing media');
        });
        
        if (lastRoomState) {
            videoElement.currentTime = lastRoomState.currentTime;
            if (lastRoomState.state === 'playing') {
                videoElement.play();
            } else {
                videoElement.pause();
            }
        }
        
        resetControlsTimeout();
    } catch (error) {
        console.error('Error creating direct media player:', error);
        showNotification('Failed to initialize media player');
    }
}

// Create appropriate player based on URL
function createPlayer(videoId, url) {
    const platform = detectPlatform(url);
    if (!platform) {
        showNotification('Unsupported platform');
        return;
    }
    
    currentPlatform = platform.id;
    
    switch(platform.id) {
        case 'youtube':
            createYouTubePlayer(videoId);
            break;
        case 'vimeo':
            createVimeoPlayer(videoId);
            break;
        case 'direct':
            createDirectMediaPlayer(url);
            break;
        case 'soundcloud':
            createSoundCloudPlayer(url);
            break;
        default:
            showNotification('Unsupported platform');
    }
}

// Retry player creation
function retryPlayerCreation(videoId) {
    if (playerLoadAttempts < 3) {
        playerLoadAttempts++;
        console.log(`Retrying player creation (attempt ${playerLoadAttempts})`);
        showNotification(`Loading player... Attempt ${playerLoadAttempts}`);
        setTimeout(() => createPlayer(videoId, elements.videoUrl.value), 2000);
    } else {
        showNotification('Failed to load player. Please refresh the page.');
    }
}

// Load video by URL
function loadVideoByUrl(url) {
    const videoId = extractVideoId(url);
    if (!videoId) {
        showNotification('Invalid video URL');
        return;
    }
    
    try {
        playerLoadAttempts = 0;
        createPlayer(videoId, url);
        isPlaying = false;
        elements.playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        
        if (!isJoiner) {
            createRoom(url);
        }
    } catch (error) {
        console.error('Error loading video:', error);
        showNotification('Failed to load video');
    }
}

// Load video from input
function loadVideo() {
    try {
        const url = elements.videoUrl.value;
        if (!url) {
            showNotification('Please enter a URL');
            return;
        }
        
        const platform = detectPlatform(url);
        if (!platform) {
            showNotification('Unsupported platform');
            return;
        }
        
        loadVideoByUrl(url);
    } catch (error) {
        console.error('Error loading video:', error);
        showNotification('Failed to load video');
    }
}

// Create a new room
function createRoom(videoUrl) {
    try {
        roomId = Math.random().toString(36).substring(2, 10);
        roomRef = database.ref(`rooms/${roomId}`);
        roomRef.set({
            videoUrl,
            state: 'paused',
            currentTime: 0,
            hostActive: true,
            joiners: 0,
            nextVideos: [],
            raiseHands: 0,
            currentHost: true,
            platform: currentPlatform,
            lastUpdated: firebase.database.ServerValue.TIMESTAMP
        });
        
        isHost = true;
        elements.modeIndicator.textContent = 'Host Mode';
        elements.modeIndicator.className = 'mode-indicator host-indicator';
        elements.modeIndicator.style.display = 'block';
        elements.hostControls.style.display = 'flex';
        elements.joinerControls.style.display = 'none';
        elements.feedbackContainer.style.display = 'flex';
        
        const roomLink = `${window.location.origin}${window.location.pathname}?roomId=${roomId}`;
        elements.copyRoomLink.style.display = 'flex';
        elements.copyRoomLink.setAttribute('data-link', roomLink);
        elements.destroyRoomBtn.style.display = 'flex';
        
        roomRef.child('joiners').on('value', (snapshot) => {
            const count = snapshot.val() || 0;
            if (count > previousJoinerCount) {
                showNotification(`${count} joiner(s) connected`);
                playBeep();
            }
            previousJoinerCount = count;
            joinerCount = count;
        });
        
        roomRef.child('nextVideos').on('value', (snapshot) => {
            nextVideos = snapshot.val() || [];
            updateBadge();
            updateQueueList();
        });
        
        roomRef.child('raiseHands').on('value', (snapshot) => {
            raiseHandCount = snapshot.val() || 0;
            if (isHost && raiseHandCount > 0) {
                const message = isPlaying ? 'STOP' : 'CONTINUE';
                showNotification(message, 3000);
                playBeep();
            }
        });
        
        syncInterval = setInterval(() => {
            if (isHost) {
                let currentTime = 0;
                let state = isPlaying ? 'playing' : 'paused';
                
                if (player && player.getCurrentTime) {
                    currentTime = player.getCurrentTime();
                } else if (vimeoPlayer) {
                    vimeoPlayer.getCurrentTime().then(function(time) {
                        currentTime = time;
                        roomRef.update({
                            currentTime,
                            state,
                            nextVideos,
                            lastUpdated: firebase.database.ServerValue.TIMESTAMP
                        });
                    });
                    return;
                } else if (currentPlatform === 'direct' && document.querySelector('video')) {
                    const video = document.querySelector('video');
                    currentTime = video.currentTime;
                    state = !video.paused ? 'playing' : 'paused';
                } else if (currentPlatform === 'soundcloud' && window.soundcloudWidget) {
                    window.soundcloudWidget.getPosition((position) => {
                        currentTime = position / 1000;
                        window.soundcloudWidget.isPaused((paused) => {
                            state = paused ? 'paused' : 'playing';
                            roomRef.update({
                                currentTime,
                                state,
                                nextVideos,
                                lastUpdated: firebase.database.ServerValue.TIMESTAMP
                            });
                        });
                    });
                    return;
                }
                
                roomRef.update({
                    currentTime,
                    state,
                    nextVideos,
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }, 1000);
        
        window.addEventListener('beforeunload', cleanupRoom);
        roomRef.child('hostActive').onDisconnect().set(false);
    } catch (error) {
        console.error('Error creating room:', error);
        showNotification('Failed to create room');
    }
}

// Clean up room on exit
function cleanupRoom() {
    try {
        if (syncInterval) {
            clearInterval(syncInterval);
            syncInterval = null;
        }
        if (roomRef && isHost) {
            roomRef.update({ hostActive: false });
        }
    } catch (error) {
        console.error('Error cleaning up room:', error);
    }
}

// Destroy room
function destroyRoom() {
    if (!roomRef) return;
    try {
        roomRef.update({
            hostActive: false,
            destroyed: true,
            lastUpdated: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            roomRef.remove();
            showNotification('Room destroyed');
            playBeep();
            resetAfterRoomDestroy();
            window.location.href = window.location.pathname;
        });
    } catch (error) {
        console.error('Error destroying room:', error);
        showNotification('Failed to destroy room');
    }
}

// Reset state after room destruction
function resetAfterRoomDestroy() {
    try {
        if (syncInterval) {
            clearInterval(syncInterval);
            syncInterval = null;
        }
        isHost = false;
        isJoiner = false;
        roomId = null;
        roomRef = null;
        elements.modeIndicator.style.display = 'none';
        elements.copyRoomLink.style.display = 'none';
        elements.destroyRoomBtn.style.display = 'none';
        elements.inputGroup.style.display = 'flex';
        nextVideos = [];
        updateBadge();
        updateQueueList();
        
        if (player && player.pauseVideo) {
            player.pauseVideo();
        } else if (document.querySelector('video')) {
            document.querySelector('video').pause();
        } else if (vimeoPlayer) {
            vimeoPlayer.pause();
        } else if (window.soundcloudWidget) {
            window.soundcloudWidget.pause();
        }
        
        elements.videoContainer.style.display = 'none';
    } catch (error) {
        console.error('Error resetting after room destroy:', error);
    }
}

// Show notification
function showNotification(message, duration = 3000) {
    elements.notificationText.textContent = message;
    elements.notification.classList.add('show');
    setTimeout(() => {
        elements.notification.classList.remove('show');
    }, duration);
}

// Apply room state to player
function applyRoomState(roomData) {
    if (!playerReady) return false;
    
    // Only apply state if the platform matches
    if (roomData.platform && currentPlatform !== roomData.platform) {
        return false;
    }
    
    let currentTime = 0;
    let playerState = false;
    
    if (player && player.getCurrentTime) {
        currentTime = player.getCurrentTime();
        if (Math.abs(currentTime - roomData.currentTime) > 1) {
            player.seekTo(roomData.currentTime, true);
        }
        if (roomData.state === 'playing' && !isPlaying) {
            player.playVideo();
            return true;
        } else if (roomData.state === 'paused' && isPlaying) {
            player.pauseVideo();
            return true;
        }
    } else if (vimeoPlayer) {
        vimeoPlayer.getCurrentTime().then(function(time) {
            if (Math.abs(time - roomData.currentTime) > 1) {
                vimeoPlayer.setCurrentTime(roomData.currentTime);
            }
        });
        
        if (roomData.state === 'playing' && !isPlaying) {
            vimeoPlayer.play();
            return true;
        } else if (roomData.state === 'paused' && isPlaying) {
            vimeoPlayer.pause();
            return true;
        }
    } else if (document.querySelector('video')) {
        const video = document.querySelector('video');
        currentTime = video.currentTime;
        if (Math.abs(currentTime - roomData.currentTime) > 1) {
            video.currentTime = roomData.currentTime;
        }
        if (roomData.state === 'playing' && video.paused) {
            video.play();
            return true;
        } else if (roomData.state === 'paused' && !video.paused) {
            video.pause();
            return true;
        }
    } else if (currentPlatform === 'soundcloud' && window.soundcloudWidget) {
        window.soundcloudWidget.getPosition((position) => {
            if (Math.abs(position/1000 - roomData.currentTime) > 1) {
                window.soundcloudWidget.seekTo(roomData.currentTime * 1000);
            }
        });
        
        window.soundcloudWidget.isPaused((paused) => {
            if (roomData.state === 'playing' && paused) {
                window.soundcloudWidget.play();
                return true;
            } else if (roomData.state === 'paused' && !paused) {
                window.soundcloudWidget.pause();
                return true;
            }
        });
    }
    return false;
}

// Join a room
function joinRoom(roomId) {
    try {
        roomRef = database.ref(`rooms/${roomId}`);
        roomRef.once('value').then((snapshot) => {
            const roomData = snapshot.val();
            if (!roomData || !roomData.hostActive) {
                showNotification('Room not found or host disconnected');
                return;
            }
            if (roomData.destroyed) {
                showNotification('Room has been destroyed');
                window.location.href = window.location.pathname;
                return;
            }
            
            isJoiner = true;
            elements.modeIndicator.textContent = 'Joiner Mode';
            elements.modeIndicator.className = 'mode-indicator joiner-indicator';
            elements.modeIndicator.style.display = 'block';
            elements.inputGroup.style.display = 'none';
            hostControls = false;
            elements.hostControls.style.display = 'none';
            elements.joinerControls.style.display = 'flex';
            elements.feedbackContainer.style.display = 'flex';
            
            lastRoomState = roomData;
            
            playerLoadAttempts = 0;
            createPlayer(extractVideoId(roomData.videoUrl), roomData.videoUrl);
            
            roomRef.on('value', (snapshot) => {
                const roomData = snapshot.val();
                if (!roomData) {
                    showNotification('Room disconnected');
                    resetAfterRoomDestroy();
                    window.location.href = window.location.pathname;
                    return;
                }
                if (roomData.destroyed) {
                    showNotification('Room destroyed by host');
                    resetAfterRoomDestroy();
                    window.location.href = window.location.pathname;
                    return;
                }
                
                nextVideos = roomData.nextVideos || [];
                updateBadge();
                updateQueueList();
                
                if (!applyRoomState(roomData)) {
                    lastRoomState = roomData;
                }
            });
            
            roomRef.child('joiners').transaction((count) => (count || 0) + 1);
            roomRef.child('raiseHands').on('value', (snapshot) => {
                raiseHandCount = snapshot.val() || 0;
                if (isJoiner && raiseHandCount > 0) {
                    showNotification('YES', 3000);
                    playBeep();
                }
            });
            
            window.addEventListener('beforeunload', () => {
                roomRef.child('joiners').transaction((count) => Math.max(0, (count || 0) - 1));
            });
        });
    } catch (error) {
        console.error('Error joining room:', error);
        showNotification('Failed to join room');
    }
}

// YouTube API callbacks
function onPlayerReady(event) {
    playerReady = true;
    try {
        // Apply stored room state immediately without delay
        if (lastRoomState) {
            event.target.seekTo(lastRoomState.currentTime, true);
            if (lastRoomState.state === 'playing') {
                event.target.playVideo();
            } else {
                event.target.pauseVideo();
            }
        }
        
        resetControlsTimeout();
    } catch (error) {
        console.error('Error in onPlayerReady:', error);
    }
}

function onPlayerStateChange(event) {
    try {
        if (event.data === YT.PlayerState.PLAYING) {
            isPlaying = true;
            elements.playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            if (isHost && roomRef) {
                roomRef.update({
                    state: 'playing',
                    currentTime: player.getCurrentTime(),
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP
                });
            }
            resetControlsTimeout();
        } else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
            isPlaying = false;
            elements.playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            if (isHost && roomRef) {
                roomRef.update({
                    state: 'paused',
                    currentTime: player.getCurrentTime(),
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP
                });
            }
            showControls();
            if (event.data === YT.PlayerState.ENDED && nextVideos.length > 0) {
                const nextVideo = nextVideos.shift();
                loadVideoByUrl(nextVideo);
                if (isHost && roomRef) {
                    roomRef.update({
                        videoUrl: nextVideo,
                        nextVideos,
                        lastUpdated: firebase.database.ServerValue.TIMESTAMP
                    });
                }
                currentVideoIndex++;
                updateBadge();
                updateQueueList();
            }
        }
    } catch (error) {
        console.error('Error in onPlayerStateChange:', error);
    }
}

function onPlayerError(event) {
    console.error('Player error:', event.data);
    const errorMessages = {
        2: 'Invalid video URL',
        5: 'HTML5 player error',
        100: 'Video not found',
        101: 'Video not allowed in embedded players',
        150: 'Video not allowed in embedded players'
    };
    showNotification(errorMessages[event.data] || 'An error occurred');
}

// Toggle play/pause
function togglePlayPause() {
    if (!playerReady) {
        showNotification('Player is not ready');
        return;
    }
    
    try {
        if (currentPlatform === 'youtube' && player && player.getPlayerState) {
            if (isPlaying) {
                player.pauseVideo();
            } else {
                player.playVideo();
            }
        } else if (currentPlatform === 'vimeo' && vimeoPlayer) {
            if (isPlaying) {
                vimeoPlayer.pause();
            } else {
                vimeoPlayer.play();
            }
        } else if (currentPlatform === 'direct' && document.querySelector('video')) {
            const video = document.querySelector('video');
            if (video.paused) {
                video.play();
            } else {
                video.pause();
            }
        } else if (currentPlatform === 'soundcloud' && window.soundcloudWidget) {
            window.soundcloudWidget.toggle();
        }
        
        showControls();
        resetControlsTimeout();
    } catch (error) {
        console.error('Error toggling play/pause:', error);
        showNotification('Error controlling player');
    }
}

// Skip forward 10 seconds
function skipForward() {
    try {
        let currentTime = 0;
        
        if (player && player.getCurrentTime) {
            currentTime = player.getCurrentTime();
            player.seekTo(currentTime + 10, true);
        } else if (vimeoPlayer) {
            vimeoPlayer.getCurrentTime().then(function(time) {
                vimeoPlayer.setCurrentTime(time + 10);
            });
        } else if (document.querySelector('video')) {
            const video = document.querySelector('video');
            currentTime = video.currentTime;
            video.currentTime = currentTime + 10;
        } else {
            showNotification('Seeking not supported for this platform');
            return;
        }
        
        if (isHost && roomRef) {
            roomRef.update({
                currentTime: currentTime + 10,
                lastUpdated: firebase.database.ServerValue.TIMESTAMP
            });
        }
        
        showControls();
        resetControlsTimeout();
    } catch (error) {
        console.error('Error skipping forward:', error);
    }
}

// Skip backward 10 seconds
function skipBackward() {
    try {
        let currentTime = 0;
        
        if (player && player.getCurrentTime) {
            currentTime = player.getCurrentTime();
            player.seekTo(Math.max(0, currentTime - 10), true);
        } else if (vimeoPlayer) {
            vimeoPlayer.getCurrentTime().then(function(time) {
                vimeoPlayer.setCurrentTime(Math.max(0, time - 10));
            });
        } else if (document.querySelector('video')) {
            const video = document.querySelector('video');
            currentTime = video.currentTime;
            video.currentTime = Math.max(0, currentTime - 10);
        } else {
            showNotification('Seeking not supported for this platform');
            return;
        }
        
        if (isHost && roomRef) {
            roomRef.update({
                currentTime: Math.max(0, currentTime - 10),
                lastUpdated: firebase.database.ServerValue.TIMESTAMP
            });
        }
        
        showControls();
        resetControlsTimeout();
    } catch (error) {
        console.error('Error skipping backward:', error);
    }
}

// Update queue list UI
function updateQueueList() {
    elements.queueList.innerHTML = '';
    
    if (nextVideos.length === 0) {
        elements.queueList.innerHTML = '<div class="queue-empty">Queue is empty</div>';
        return;
    }
    
    nextVideos.forEach((videoUrl, index) => {
        const platform = detectPlatform(videoUrl);
        const item = document.createElement('div');
        item.className = 'queue-item';
        
        const info = document.createElement('div');
        info.className = 'queue-item-info';
        
        const title = document.createElement('div');
        title.className = 'queue-item-title';
        title.textContent = `Video ${index + 1}${platform ? ` (${platform.name})` : ''}`;
        
        const url = document.createElement('div');
        url.className = 'queue-item-url';
        url.textContent = videoUrl;
        
        info.appendChild(title);
        info.appendChild(url);
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'queue-item-remove';
        removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
        removeBtn.title = 'Remove from queue';
        removeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            removeFromQueue(index);
        });
        
        item.appendChild(info);
        item.appendChild(removeBtn);
        
        elements.queueList.appendChild(item);
    });
}

// Remove video from queue
function removeFromQueue(index) {
    if (index < 0 || index >= nextVideos.length) return;
    
    nextVideos.splice(index, 1);
    
    if (isHost && roomRef) {
        roomRef.update({ nextVideos });
    } else if (isJoiner && roomRef) {
        roomRef.child('nextVideos').transaction((queue) => {
            const newQueue = queue || [];
            if (index >= 0 && index < newQueue.length) {
                newQueue.splice(index, 1);
                return newQueue;
            }
            return queue;
        });
    }
    
    updateBadge();
    updateQueueList();
    showNotification('Video removed from queue');
}

// Add video to queue
function addToQueue(videoUrl) {
    if (!videoUrl) return;
    
    if (isJoiner && nextVideos.length >= 3) {
        showNotification('Queue is full (max 3 videos)');
        return;
    }
    
    if (isHost) {
        if (nextVideos.length < 3) {
            nextVideos.push(videoUrl);
            if (roomRef) {
                roomRef.update({ nextVideos });
            }
            showNotification('Video added to queue');
            updateBadge();
            updateQueueList();
        } else {
            showNotification('Queue is full (max 3 videos)');
        }
    } else if (isJoiner && roomRef) {
        roomRef.child('nextVideos').transaction((queue) => {
            const newQueue = queue || [];
            if (newQueue.length < 3) {
                newQueue.push(videoUrl);
                return newQueue;
            }
            return queue;
        });
        showNotification('Video added to queue');
    }
}

// Open queue modal
function openQueueModal() {
    elements.queueModal.classList.add('active');
    elements.queueInput.value = '';
    elements.queueInput.focus();
    showControls();
    resetControlsTimeout();
}

// Close queue modal
function closeQueueModal() {
    elements.queueModal.classList.remove('active');
    showControls();
    resetControlsTimeout();
}

// Handle queue submission
function handleQueueSubmit() {
    const videoUrl = elements.queueInput.value;
    if (videoUrl) {
        addToQueue(videoUrl);
        elements.queueInput.value = '';
    } else {
        showNotification('Please enter a valid URL');
    }
}

// Manage queue
function manageQueue() {
    openQueueModal();
}

// Update queue badge
function updateBadge() {
    elements.nextVideoBadge.textContent = nextVideos.length;
    elements.nextVideoBadge.style.display = nextVideos.length > 0 ? 'flex' : 'none';
}

// Toggle fullscreen
function toggleFullscreen() {
    try {
        if (currentPlatform === 'vimeo' && vimeoPlayer) {
            vimeoPlayer.getFullscreen().then(function(fullscreen) {
                if (fullscreen) {
                    vimeoPlayer.exitFullscreen();
                } else {
                    vimeoPlayer.requestFullscreen();
                }
            });
            return;
        }
        
        let element;
        
        // Determine which element to make fullscreen based on platform
        if (currentPlatform === 'direct') {
            element = document.querySelector('video') || elements.videoContainer;
        } else if (currentPlatform === 'soundcloud') {
            element = document.querySelector('iframe') || elements.videoContainer;
        } else {
            element = elements.videoContainer;
        }

        if (!document.fullscreenElement) {
            element.requestFullscreen().catch(err => {
                showNotification(`Fullscreen error: ${err.message}`);
            });
            elements.fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
            elements.joinerFullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
        } else {
            document.exitFullscreen();
            elements.fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            elements.joinerFullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
        }
        showControls();
        resetControlsTimeout();
    } catch (error) {
        console.error('Error toggling fullscreen:', error);
        showNotification('Fullscreen not supported');
    }
}

// Copy room link
function copyRoomLink() {
    try {
        const roomLink = elements.copyRoomLink.getAttribute('data-link');
        navigator.clipboard.writeText(roomLink).then(() => {
            showNotification('Room link copied to clipboard');
        }).catch(err => {
            console.error('Failed to copy room link:', err);
            showNotification('Failed to copy link');
        });
    } catch (error) {
        console.error('Error copying room link:', error);
    }
}

// Leave room
function leaveRoom() {
    if (roomRef && isJoiner) {
        roomRef.child('joiners').transaction((count) => Math.max(0, (count || 0) - 1));
        resetAfterRoomDestroy();
        window.location.href = window.location.pathname;
    }
}

// Raise hand
function raiseHand() {
    if (!roomRef) return;
    
    try {
        roomRef.child('raiseHands').transaction((count) => (count || 0) + 1);
        if (isHost) {
            showNotification('Hand raised!', 3000);
            playBeep();
        }
    } catch (error) {
        console.error('Error raising hand:', error);
        showNotification('Failed to raise hand');
    }
}

// Show controls
function showControls() {
    elements.controlsContainer.style.opacity = '1';
    elements.controlsContainer.style.pointerEvents = 'auto';
}

// Hide controls
function hideControls() {
    elements.controlsContainer.style.opacity = '0';
    elements.controlsContainer.style.pointerEvents = 'none';
}

// Reset controls timeout
function resetControlsTimeout() {
    if (controlsTimeout) {
        clearTimeout(controlsTimeout);
    }
    showControls();
    controlsTimeout = setTimeout(hideControls, 3000);
}

// Handle user interaction
const handleInteraction = debounce(() => {
    showControls();
    resetControlsTimeout();
}, 100);

// Initialize YouTube API
window.onYouTubeIframeAPIReady = () => {
    apiReady = true;
    if (pendingVideoId) {
        createYouTubePlayer(pendingVideoId);
        pendingVideoId = null;
    }
};

// Initialize on DOM load
document.addEventListener('DOMContentLoaded', () => {
    initAudio();
    
    const urlParams = new URLSearchParams(window.location.search);
    const joinRoomId = urlParams.get('roomId');
    if (joinRoomId) {
        joinRoom(joinRoomId);
    }
    
    elements.loadVideo.addEventListener('click', loadVideo);
    elements.playPauseBtn.addEventListener('click', togglePlayPause);
    elements.backwardBtn.addEventListener('click', skipBackward);
    elements.forwardBtn.addEventListener('click', skipForward);
    elements.nextVideoBtn.addEventListener('click', manageQueue);
    elements.joinerNextVideoBtn.addEventListener('click', manageQueue);
    elements.fullscreenBtn.addEventListener('click', toggleFullscreen);
    elements.joinerFullscreenBtn.addEventListener('click', toggleFullscreen);
    elements.copyRoomLink.addEventListener('click', copyRoomLink);
    elements.destroyRoomBtn.addEventListener('click', destroyRoom);
    elements.videoUrl.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loadVideo();
    });
    elements.videoContainer.addEventListener('mousemove', handleInteraction);
    elements.videoContainer.addEventListener('touchstart', handleInteraction, { passive: true });
    
    elements.leaveRoomBtn.addEventListener('click', leaveRoom);
    elements.raiseHandBtn.addEventListener('click', raiseHand);
    
    elements.closeQueueModal.addEventListener('click', closeQueueModal);
    elements.queueSubmit.addEventListener('click', handleQueueSubmit);
    elements.queueInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleQueueSubmit();
    });
    elements.queueModal.addEventListener('click', (e) => {
        if (e.target === elements.queueModal) {
            closeQueueModal();
        }
    });
    
    resetControlsTimeout();
    
    document.addEventListener('fullscreenchange', () => {
        if (document.fullscreenElement) {
            elements.fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
            elements.joinerFullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
            showNotification('Entered fullscreen mode', 2000);
        } else {
            elements.fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            elements.joinerFullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            showNotification('Exited fullscreen mode', 2000);
        }
        showControls();
        resetControlsTimeout();
    });
});
    </script>
</body>
</html>
